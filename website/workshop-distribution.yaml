AWSTemplateFormatVersion: "2010-09-09"

Parameters:
  ParentStack:
    Type: String

  WorkshopName:
    Type: String

  ParentZone:
    Type: String
    Default: aws.seibtribe.com

Resources:
  ACMValidateFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: seibeast
        S3Key: ACMValidateFunction.zip
      FunctionName: !Sub "${ParentStack}-ACMValidateFunction"
      Handler: acm_autovalidate.handler
      Role:
        Fn::GetAtt:
          - ACMValidateRole
          - Arn
      Runtime: python3.6

  ACMValidateRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - acm:DescribeCertificate
                  - acm:ListCertificates
                  - acm:RequestCertificate
                  - acm:DeleteCertificate
                  - route53:ListHostedZonesByName
                  - route53:ChangeResourceRecordSets
                Effect: Allow
                Resource: "*"
            Version: "2012-10-17"
          PolicyName: !Sub "${ParentStack}-ACMandRoute53Access"

  ACMCertificate:
    Type: Custom::ACMAutoValidate
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - ACMValidateFunction
          - Arn
      zoneid: !Ref WorkshopDNSZone
      domainname: !Join [".", ["*", Ref: WorkshopName, Ref: ParentZone]]
      additionalnames:
        - !Join [".", [Ref: WorkshopName, Ref: ParentZone]]

  WorkshopDNSZone:
    Type: AWS::Route53::HostedZone
    Properties:
      HostedZoneConfig:
        Comment: !Join ["", ["Hosted zone for ", !Ref "WorkshopName"]]
      Name: !Join [".", [Ref: WorkshopName, Ref: ParentZone]]
      HostedZoneTags:
        - Key: Workshop
          Value: !Ref WorkshopName

  CDNDNS:
    Type: AWS::Route53::RecordSet
    Properties:
      Name: !Join ["", [cdn, ".", Ref: WorkshopName, ".", Ref: ParentZone, "."]]
      HostedZoneName: !Join ["", [Ref: WorkshopName, ".", Ref: ParentZone, "."]]
      Type: A
      AliasTarget:
        HostedZoneId: Z2FDTNDATAQYW2
        DNSName: !GetAtt [WebsiteCloudfront, DomainName]

  ApexDNS:
    Type: AWS::Route53::RecordSetGroup
    DependsOn:
      - CDNDNS
    Properties:
      HostedZoneName: !Join ["", [Ref: WorkshopName, ".", Ref: ParentZone, "."]]
      RecordSets:
        - Name: !Join ["", [Ref: WorkshopName, ".", Ref: ParentZone, "."]]
          Type: A
          AliasTarget:
            HostedZoneId: !Ref WorkshopDNSZone
            DNSName:
              !Join [
                "",
                [cdn, ".", Ref: WorkshopName, ".", Ref: ParentZone, "."],
              ]

  CloudFrontOriginIdentity:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: !Join ["", ["origin identity for", Ref: WorkshopName]]

  WebsiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      WebsiteConfiguration:
        IndexDocument: index.html

  WebsitePolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Fn::ImportValue: !Sub "${ParentStack}-WebBucket"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              CanonicalUser:
                Fn::GetAtt: [CloudFrontOriginIdentity, S3CanonicalUserId]
            Action: "s3:GetObject"
            Resource:
              !Join [
                "",
                ["Fn::ImportValue": !Sub "${ParentStack}-WebARN", "/*"],
              ]

  WebsiteCloudfront:
    Type: AWS::CloudFront::Distribution
    DependsOn:
      - WebsiteBucket
    Properties:
      DistributionConfig:
        Comment: Cloudfront Distribution pointing to S3 bucket
        Origins:
          - DomainName:
              !Join [
                "",
                [
                  "Fn::ImportValue": !Sub "${ParentStack}-WebBucket",
                  ".s3.amazonaws.com",
                ],
              ]
            Id: webpage
            S3OriginConfig:
              OriginAccessIdentity: !Sub "origin-access-identity/cloudfront/${CloudFrontOriginIdentity}"
        Enabled: true
        HttpVersion: "http2"
        DefaultRootObject: index.html
        Aliases:
          - !Join [".", [cdn, Ref: WorkshopName, Ref: ParentZone]]
          - !Join [".", [Ref: WorkshopName, Ref: ParentZone]]
        DefaultCacheBehavior:
          AllowedMethods:
            - GET
            - HEAD
          Compress: true
          DefaultTTL: 60
          TargetOriginId: webpage
          ForwardedValues:
            QueryString: true
            Cookies:
              Forward: none
          ViewerProtocolPolicy: redirect-to-https
        PriceClass: PriceClass_100
        ViewerCertificate:
          AcmCertificateArn: !Ref WildACM
          SslSupportMethod: sni-only
